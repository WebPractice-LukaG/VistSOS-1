<html>
  <head>
    <meta charset="utf-8">
    <title>istSOS Chart Component</title>
    <script src="../bower_components/webcomponentsjs/webcomponents.min.js"></script>
    <script src="../bower_components/javascript-core/compiled/istsos-core-compiled.js"></script>
    <script src="//d3js.org./d3.v3.min.js"></script>
    <script src="//vega.github.io/vega/vega.js"></script>
    <script src="//vega.github.io/vega-lite/vega-lite.js"></script>
    <script src="//vega.github.io/vega-editor/vendor/vega-embed.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script> 
    <script src="data/javascript/data-provider.js"></script> 
    <script src="util/util.js"></script>
    <style>
      .tooltip {
        width: 100%;
        display: block;
      }
      .vega-actions a {
        margin-right: 5px;
      }
    </style>
  </head>
  <body>
    <script>
      $.ajaxSetup({ async: true });

      // Define and register HTML element <istsos-chart>
      var proto = Object.create(HTMLElement.prototype);
       
      proto.createdCallback = function() {
        var jsonSpec = {};
        var measurements = [];
        var vegaMode = "vega-lite";
        var server = this.getAttribute("server");
        var service = this.getAttribute("service");
        var offering = this.getAttribute("offering");
        var procedure = this.getAttribute("procedure");
        var props = this.getAttribute("property").split(",");
        var from = this.getAttribute("from");
        var until = this.getAttribute("until");
        var chartType = this.getAttribute("type");
        var color = this.getAttribute("color");
        var divId = this.getAttribute("divId");

        if (moment.utc(from).isValid() && moment.utc(until).isValid()) {
          getObservations(server, service, offering, procedure, props, from, until, loadSpec); // from data-provider.js 
        }

        function loadSpec(data) {
          measurements = data;
        
          if (chartType == "line") {
            getJSONSpec("default-lines-spec", embedChart); // from util.js
          } else if (chartType == "bar") {
            getJSONSpec("default-bars-spec", embedChart);
          } else if (chartType == "punch-card") {
            getJSONSpec("default-punch-card-spec", embedChart);
          } else if (chartType == "scatterplot") {
            getJSONSpec("default-scatterplot-spec", embedChart);
          } else if (chartType == "overview-detail") {
            vegaMode = "vega";
            getJSONSpec("default-overview-detail-spec", embedChart);
          }
        }

        function embedChart(jsonSpec) { 
          if (chartType == "overview-detail") {
            var sfrom = moment(from).format("MMM d YYYY");
            var suntil = moment(until).format("MMM d YYYY");

            jsonSpec.data[0].values = measurements;
            var prop1 = props[0];
            jsonSpec.data[0].format.parse[prop1] = jsonSpec.data[0].format.parse["measurement"];
            delete jsonSpec.data[0].format.parse["measurement"];
            jsonSpec.scales[1].domain.field = props[0];
            jsonSpec.scales[3].domain.field = props[0];
            jsonSpec.marks[0].marks[0].marks[0].properties.update.y.field = props[0];
            jsonSpec.marks[1].marks[0].properties.update.y.field = props[0];

            jsonSpec.signals[1].init.expr = "datetime('" + sfrom + "')";
            jsonSpec.signals[2].init.expr = "datetime('" + sfrom + "')";
            jsonSpec.signals[2].expr = "time(brush_start) === time(brush_end) ? datetime('" + sfrom + "') : min(brush_start, brush_end)";
            jsonSpec.signals[3].init.expr = "datetime('" + suntil + "')";
            jsonSpec.signals[3].expr = "time(brush_start) === time(brush_end) ? datetime('" + suntil + "') : max(brush_start, brush_end)";

            jsonSpec.marks[0].marks[0].marks[0].properties.update.fill.value = "#" + color;
          } else if (chartType == "punch-card") {
            jsonSpec.data.values = measurements;
            jsonSpec.encoding.size.field = props[0];
            jsonSpec.encoding.color.value = "#" + color;
          } else {
            jsonSpec.data.values = measurements;
            jsonSpec.encoding.y.field = props[0];
            jsonSpec.encoding.color.value = "#" + color;
          }
          
          var embedSpec = { mode: vegaMode, spec: jsonSpec };
          vg.embed("#" + divId, embedSpec, function(error, result) { });
        }
      };

      document.registerElement("istsos-chart", {prototype: proto});
    </script>
  </body>
</html>
